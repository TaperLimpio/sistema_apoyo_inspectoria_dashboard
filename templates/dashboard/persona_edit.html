{% extends 'dashboard/base_generic.html' %}

{% block sidebar %}
{{ block.super }}
{% endblock %}

{% block content %}
    <h3>Editar persona: {{ persona.nombre }}</h3>

    <div class="mt-3">
        <form method="post" class="row g-3">
            {% csrf_token %}
            <div class="col-12">
                <label for="id_nombre" class="form-label" style="color:#d7d9ff">Nombre completo</label>
                {{ form.nombre }}
            </div>

            <div class="col-md-6">
                <label for="id_rut" class="form-label" style="color:#d7d9ff">RUT</label>
                {{ form.rut }}
            </div>

            <div class="col-md-6">
                <label for="id_fono" class="form-label" style="color:#d7d9ff">Tel√©fono</label>
                {{ form.fono }}
            </div>

            <div class="col-12">
                <label for="id_tipo_persona" class="form-label" style="color:#d7d9ff">Tipo</label>
                {{ form.tipo_persona }}
            </div>

            {% if persona.qrcode and persona.qrcode != '0' %}
            <div class="col-12">
                <label class="form-label" style="color:#d7d9ff">QR (persistente)</label>
                <div>
                    <div class="d-flex align-items-center gap-3">
                        <div id="qrcode-persona" style="width:140px;height:140px"></div>
                        <div>
                            <code style="word-break: break-all;">{{ persona.qrcode }}</code>
                            <div class="mt-2 d-flex gap-2">
                                <button class="btn btn-sm btn-outline-light" onclick="navigator.clipboard.writeText('{{ persona.qrcode }}')">Copiar</button>
                                <a class="btn btn-sm btn-outline-light" href="{% url 'qr_image' persona.qrcode %}?download=1">Descargar</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

{% block scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            const el = document.getElementById('qrcode-persona');
            if (el){
                const token = "{{ persona.qrcode }}";
                if (token && token !== '0'){
                    try{ new QRCode(el, { text: token, width: 140, height: 140 }); }catch(e){console.warn(e)}
                }
            }
        });
    </script>
{% endblock %}

            <div class="col-12 d-flex gap-2">
                <button type="submit" class="btn btn-primary">Guardar cambios</button>
                <a href="{% url 'personas_view' %}" class="btn btn-outline-light">Cancelar</a>
            </div>
        </form>
    </div>

{% endblock %}
